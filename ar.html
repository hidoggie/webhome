<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        .ar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none;}
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; max-height: 40%; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        .hide { display: none; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.5em; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <a-scene id="ar-scene" 
             mindar-image="imageTargetSrc: /static/targets.mind; autoStart: false;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>

    <div class="ar-overlay">
        <!--div id="loading-overlay">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">AR ì—”ì§„ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div-->
        <div></div> 
        <div id="ar-description-box" class="hide">
            <p id="ar-text"></p>
            <button id="ar-tts-btn" class="ar-button" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
    const sceneEl = document.querySelector('a-scene');
    const descriptionBox = document.getElementById('ar-description-box');
    const arText = document.getElementById('ar-text');
    const arTtsBtn = document.getElementById('ar-tts-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    let pdfContent = [];
    let audioContext;
    let currentAudio = null; // í˜„ì¬ ì¬ìƒí•  ì˜¤ë””ì˜¤ ê°ì²´

    try {
        const response = await fetch('/api/pdf-content');
        pdfContent = await response.json();
        
        // ... (ì´ì „ê³¼ ë™ì¼í•œ ë™ì  íƒ€ê²Ÿ ìƒì„± ë¡œì§) ...
        pdfContent.flatMap(p => p.images).forEach((imageName, index) => {
            const entity = document.createElement('a-entity');
            entity.setAttribute('mindar-image-target', `targetIndex: ${index}`);
            entity.setAttribute('data-image-name', imageName); 
            sceneEl.appendChild(entity);
        });

        const targetEntities = document.querySelectorAll('[mindar-image-target]');
        targetEntities.forEach(target => {
            // âœ¨âœ¨âœ¨ targetFound ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì • âœ¨âœ¨âœ¨
            target.addEventListener("targetfound", async (event) => {
                const foundImageName = event.target.getAttribute('data-image-name');
                if (foundImageName) {
                    // 1. ì„¤ëª…ì°½ì— ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                    arText.textContent = "AI ë„ìŠ¨íŠ¸ê°€ í•´ì„¤ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...";
                    descriptionBox.classList.remove('hidden');
                    arTtsBtn.classList.add('hidden'); // ìŒì„± ë²„íŠ¼ì€ ì¼ë‹¨ ìˆ¨ê¹€

                    // 2. ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                    const queryResponse = await fetch('/api/ar-query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_name: foundImageName })
                    });
                    const data = await queryResponse.json();

                    if (data.text && data.audio) {
                        // 3. AIê°€ ìƒì„±í•œ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•˜ê³ , ì˜¤ë””ì˜¤ ë°ì´í„° ì¤€ë¹„
                        arText.textContent = data.text;
                        currentAudio = new Audio("data:audio/mp3;base64," + data.audio);
                        arTtsBtn.classList.remove('hidden'); // ìŒì„± ë²„íŠ¼ í‘œì‹œ
                    } else {
                        arText.textContent = "í•´ì„¤ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    }
                }
            });
            target.addEventListener("targetlost", event => {
                descriptionBox.classList.add('hidden');
                if (currentAudio) {
                    currentAudio.pause(); // í™”ë©´ì—ì„œ ì‚¬ë¼ì§€ë©´ ì˜¤ë””ì˜¤ ì¤‘ì§€
                    currentAudio = null;
                }
            });
        });
        
        const arSystem = sceneEl.systems['mindar-image-system'];
        sceneEl.addEventListener('arready', () => {
            loadingOverlay.classList.add('hidden');
        });
        await arSystem.start();

        } catch (e) {
      //      loadingOverlay.classList.add('hide');
            console.error("AR ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            alert(e.message || "AR ê¸°ëŠ¥ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ, ì‚¬ìš©ìê°€ ì´ ì°½ì„ ë‹«ì„ ìˆ˜ ìˆë„ë¡ ì•ˆë‚´
            document.body.innerHTML = `<div style="text-align: center; padding-top: 40px; font-size: 1.2em;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì´ íƒ­ì„ ë‹«ê³  ì±—ë´‡ìœ¼ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
        }

         // âœ¨ ìŒì„± ì•ˆë‚´ ë²„íŠ¼ì€ ì¤€ë¹„ëœ ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒë§Œ í•˜ë„ë¡ ìˆ˜ì •
    arTtsBtn.onclick = () => {
        if (currentAudio) {
            currentAudio.play();
        }
    };

    });
    </script>
</body>
</html>