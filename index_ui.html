<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI Docent Bot</title>    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        .view { display: none; width: 100%; height: 100%; flex-direction: column; box-sizing: border-box; }
        .view.active { display: flex; }
        
        /* Ï±óÎ¥á Î∑∞ */
        #chatbot-view { align-items: center; justify-content: flex-start; background-color: #f0f2f5; }
        #container { display: flex; flex-direction: column; width: 100%; max-width: 800px; height: 100%; background-color: white; }
        #chat-header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #transcript { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #input-area { display: flex; gap: 10px; padding: 10px; border-top: 1px solid #ddd; flex-shrink: 0; align-items: center; }
        #text-input { width: 100%; flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; font-size: 1em; }
        .message { margin-bottom: 12px; line-height: 1.5; display: flex; flex-direction: column; }
        .user { align-self: flex-end; }
        .user p { background-color: #007bff; color: white; padding: 8px 12px; border-radius: 15px; display: inline-block; max-width: 100%; }
        .ai { align-self: flex-start; }
        .ai p { background-color: #e9ecef; color: black; padding: 8px 12px; border-radius: 15px; display: inline-block; max-width: 100%; }
        .system { width: 100%; text-align: center; color: #6c757d; font-style: italic;}
        
        /* AR Î∑∞ */
        #ar-view { position: relative; }
        #ar-iframe { width: 100%; height: 100%; border: none; }
        #back-from-ar-btn { position: absolute; top: 20px; left: 20px; z-index: 10; padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; }
        
        .hidden { display: none; }
        .btn { padding: 10px; width: 50px; height: 50px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 1.5em; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
         #goto-ar-btn {
             background-color: transparent;
             width: 80px;
             height: 60px;
             background-image: url('./image/ar_logo_ver3_35.gif');
             background-repeat: no-repeat;
             background-position: right; /* or specific coordinates */
             background-size: contain; /* or cover, or specific dimensions */
             font-size: 1em; 
             border-radius: 5px;
             border: none;
             cursor: pointer;
             text-indent: -9999px; 
             overflow: hidden;
             margin-right: 10px;
         }
        #recordBtn { background-color: white; 
                    background-image: url('./image/mic_b_32.png');
                    background-repeat: no-repeat;
                    background-position: center; /* or specific coordinates */
                    background-size: auto; /* or cover, or specific dimensions */
                    width: 40px; /* Adjust as needed */
                    height: 40px; /* Adjust as needed */
                    border: none;
                    cursor: pointer;
        /* Optionally hide text if image serves as the sole visual */
                    text-indent: -9999px; 
                    overflow: hidden;
                   }
        #recordBtn.recording { background-color: #dc3545; background-image: url('image/stop.png');}
        #send-btn { background-color: white; background-image: url('./image/send_skyblue_32.png');
        background-repeat: no-repeat;
        background-position: center; /* or specific coordinates */
        background-size: auto; /* or cover, or specific dimensions */
        width: 35px; /* Adjust as needed */
        height: 35px; /* Adjust as needed */
        border: none;
        cursor: pointer;
        /* Optionally hide text if image serves as the sole visual */
        text-indent: -9999px; 
        overflow: hidden;}
        #playBtn { background-color: white; 
                    background-image: url('./image/play_b1_32.png');
                    background-repeat: no-repeat;
                    background-position: center; /* or specific coordinates */
                    background-size: auto; /* or cover, or specific dimensions */
                    width: 40px; /* Adjust as needed */
                    height: 40px; /* Adjust as needed */
                    border: none;
                    cursor: pointer;
        /* Optionally hide text if image serves as the sole visual */
                    text-indent: -9999px; 
                    overflow: hidden; 
                    margin-right: 10px;
                 }
        #playBtn:disabled, #recordBtn:disabled, #send-btn:disabled { background-color: #6c757d; cursor: not-allowed; }

        .blink-soft {
          animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
          50% {
            opacity: 0;
          }
       }
      .input-wrapper {
        width: 90%;
        position: relative;
        display: flex;
      }        
      .input-wrapper input {
        padding-right: 40px;
      }
      .input-wrapper button {
        position: absolute;
        right: 5px;
        top: 2px;
       }
    </style>
</head>
<body>
    <div id="chatbot-view" class="view active">
        <div id="container">
            <header id="chat-header">
                <h2>
                   <div style="overflow: hidden;">
                   <img src="./image/ardocent_ver2_35.gif" style="float: left; margin-left: 15px; margin-right: 15px;" alt="ÎèÑÏä®Ìä∏Î¥á Î°úÍ≥†">
                   <span>
                     AI ÎèÑÏä®Ìä∏Î¥á
                   </span>
                   </div>
                </h2>
                <button id="goto-ar-btn" class="ar-button"></button>
            </header>
            <main id="transcript"></main>
            <footer id="input-area">
                <button id="recordBtn" class="btn"></button>
                <div class="input-wrapper">
                  <input type="text" id="text-input" placeholder="ÌÖçÏä§Ìä∏Î°ú ÏßàÎ¨∏ÌïòÏÑ∏Ïöî...">
                  <button id="send-btn" class="btn" onclick="alert('success');"></button>
                </div>
                <button id="playBtn" class="btn hidden"></button>
            </footer>
        </div>
    </div>
<script>
   const recordBtn = document.getElementById('recordBtn');
   var count = 1;
   recordBtn.onclick = () => {
       if(count%2 == 1){
           recordBtn.classList.add('blink-soft');
       } 
       else {
           recordBtn.classList.remove('blink-soft');
       }
       count++;
   }
    
   const PlayBtn = document.getElementById('playBtn');
   var Pcount = 1;
   PlayBtn.onclick = () => {
       if(Pcount%2 == 1){
           PlayBtn.classList.add('blink-soft');
       } 
       else {
           PlayBtn.classList.remove('blink-soft');
       }
       Pcount++;
   } 
</script>

    <!--script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Ï±óÎ¥á Î∞è AR Î∑∞ Í≥µÌÜµ ÏöîÏÜå ---
        const chatbotView = document.getElementById('chatbot-view');
 
        const gotoArBtn = document.getElementById('goto-ar-btn');

        // --- Ï±óÎ¥á Ï†ÑÏö© ÏöîÏÜå ---
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const transcriptDiv = document.getElementById('transcript');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        
        // --- Ï±óÎ¥á ÏÉÅÌÉú Î≥ÄÏàò ---
        let socket, mediaRecorder, audioChunks = [], isRecording = false;
        let lastInputWasVoice = false, audioContext = null, currentAudioSource = null;

        // --- ÌôîÎ©¥ Ï†ÑÌôò Î°úÏßÅ ---
            gotoArBtn.onclick = () => {
              console.log("AR ÎèÑÏä®Ìä∏ ÏÉà ÌÉ≠ÏúºÎ°ú Ïó¥Í∏∞...");
              window.open('/ar', '_blank');
            };
            
    
        function isIOS() { return /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream; }

        function addMessageToTranscript(type, data) {
          const p = document.createElement('div');
          p.className = 'message ' + type.replace('_text', '');
          if (type === 'user_text') {
              p.innerHTML = `<p>${data}</p>`;
          } else if (type === 'ai_text') {
              p.innerHTML = `<p>${data}</p>`;
          } else if (type === 'ai_image') {
              p.innerHTML = `<img src="${data.url}" alt="AI generated image" style="max-width: 100%; border-radius: 8px; margin-top: 5px;">`;
          } else {
              p.innerHTML = `<p class="system">${data}</p>`;
          }
          transcriptDiv.appendChild(p);
          transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        function setInputs(enabled) { 
            recordBtn.disabled = !enabled; 
            sendBtn.disabled = !enabled; 
            textInput.disabled = !enabled; 
            if(enabled){recordBtn.classList.remove('recording'); 
            recordBtn.style.backgroundImage = 'url("new-image.jpg")';} 
        }

        function connectWebSocket() {
            const socketURL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
            socket = new WebSocket(socketURL);
            socket.onopen = () => { setInputs(true); addMessageToTranscript('system', 'Ï±óÎ¥áÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.'); };
            socket.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    const audioBlob = event.data;
                    const shouldAutoplay = lastInputWasVoice && !isIOS();
                    if (shouldAutoplay) {
                        playReceivedAudio(audioBlob);
                    } else {
                        playBtn.onclick = () => playReceivedAudio(audioBlob);
                        playBtn.classList.remove('hidden');
                        setInputs(true);
                    }
                } else {
                    const message = JSON.parse(event.data);
                    addMessageToTranscript(message.type, message.data);
                }
            };
            socket.onclose = () => { addMessageToTranscript('system', 'ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'); setInputs(false); };
        }

        function sendTextMessage() {
            const text = textInput.value.trim();
//            if (!text || socket?.readyState !== WebSocket.OPEN) return;
            if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;
            lastInputWasVoice = false;
            socket.send(JSON.stringify({ type: 'text', data: text }));
            addMessageToTranscript('user_text', text);
            textInput.value = "";
            setInputs(false);
            playBtn.classList.add('hidden');
        }

        async function startRecording() {
            lastInputWasVoice = true;
            setInputs(false); recordBtn.disabled = false;
            playBtn.classList.add('hidden');
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        if (socket?.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ type: 'audio', data: base64Audio }));
                    };
                };
                mediaRecorder.start();
                isRecording = true;
   //             recordBtn.textContent = "üéôÔ∏è";
                recordBtn.style.
                recordBtn.classList.add('recording');
            } catch (err) { alert("ÎßàÏù¥ÌÅ¨Ïóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§."); setInputs(true); }
        }

 //       function stopRecording() { if (mediaRecorder) mediaRecorder.stop(); isRecording = false; recordBtn.textContent = "üé§"; recordBtn.classList.remove('recording'); setInputs(false); }
        function stopRecording() { if (mediaRecorder) mediaRecorder.stop(); isRecording = false; setInputs(false); }

        
        async function playReceivedAudio(audioBlob) {
            if (currentAudioSource) currentAudioSource.stop();
            if (!audioBlob) return;
            
  //          playBtn.classList.remove('hidden');
  //          playBtn.textContent = "‚è∏Ô∏è Îì£Í∏∞ Ï§ëÏßÄ";
   //         playBtn.onclick = stopCurrentAudio;
  //          setInputs(false);

            setInputs(false, "ÎãµÎ≥ÄÏùÑ Ïû¨ÏÉùÌï©ÎãàÎã§...");
            playBtn.classList.remove('hidden');
            playBtn.textContent = "‚è∏Ô∏è"; // ÏïÑÏù¥ÏΩòÎßå ÌëúÏãú
            playBtn.onclick = () => stopCurrentAudio(true);
            playBtn.classList.add('playing');



            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            
            try {
                const arrayBuffer = await audioBlob.arrayBuffer();
                const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                currentAudioSource = audioContext.createBufferSource();
                currentAudioSource.buffer = decodedBuffer;
                currentAudioSource.connect(audioContext.destination);
                currentAudioSource.start(0);
                currentAudioSource.onended = () => { if (currentAudioSource) stopCurrentAudio(false); };
            } catch(e) { console.error("Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:", e); stopCurrentAudio(false); }
        }

        function stopCurrentAudio(isManualStop = true) {
            if (currentAudioSource) {
                currentAudioSource.onended = null;
                if(isManualStop) currentAudioSource.stop();
                currentAudioSource = null;
            }
            playBtn.classList.add('hidden');
            playBtn.textContent = "‚ñ∂Ô∏è";
 //           setInputs(true);
            playBtn.classList.remove('playing');
            setInputs(true, isManualStop ? "Ïû¨ÏÉùÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§." : "Ïû¨ÏÉùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");

        }

        recordBtn.onclick = () => isRecording ? stopRecording() : startRecording();
        sendBtn.onclick = sendTextMessage;
        textInput.addEventListener('keyup', e => { if (e.key === 'Enter') sendTextMessage(); });
        
        connectWebSocket();
    });
    </script-->
</body>

</html>





































